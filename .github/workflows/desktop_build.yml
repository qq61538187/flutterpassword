name: Build Desktop (macOS DMG & Windows Installer)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # å®‰è£…æŒ‡å®šç‰ˆæœ¬ Flutterï¼ˆä¸ä½ æœ¬åœ°ä¿æŒä¸€è‡´ï¼‰
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: "3.38.3"
          cache: true

      - name: Flutter doctor (optional)
        run: flutter doctor -v

      - name: Read app version
        shell: bash
        run: |
          set -euo pipefail
          # ä» pubspec.yaml è¯»å– version:ï¼Œå¹¶åšæ¸…æ´—ï¼š
          # - å»æ‰ build numberï¼ˆ+ åé¢çš„å†…å®¹ï¼‰
          # - å»æ‰ Windows å¯èƒ½å¸¦æ¥çš„ \r
          # - ä»…ä¿ç•™ [0-9A-Za-z._-]ï¼Œé¿å…æ–‡ä»¶å/å®‰è£…åŒ…åéæ³•
          raw="$(grep -E '^version:' pubspec.yaml | head -n 1 | sed 's/^version:[[:space:]]*//')"
          ver="${raw%%+*}"
          ver="$(printf '%s' "$ver" | tr -d '\r\n')"
          ver="$(printf '%s' "$ver" | tr -cd '0-9A-Za-z._-')"
          if [ -z "$ver" ]; then
            echo "æ— æ³•ä» pubspec.yaml è§£æ version:" >&2
            exit 1
          fi
          echo "APP_VERSION=$ver"
          echo "APP_VERSION=$ver" >> "$GITHUB_ENV"

      - name: Pub get
        run: flutter pub get

      # ç”Ÿæˆä»£ç ï¼ˆå¦‚ Hive / build_runnerï¼‰ï¼Œé¿å… CI å› ç¼ºå°‘ *.g.dart å¤±è´¥
      - name: Build runner
        run: dart run build_runner build --delete-conflicting-outputs

      # ä»æºå›¾æ ‡ç”Ÿæˆåº”ç”¨å›¾æ ‡ï¼ˆmacOS å’Œ Windowsï¼‰
      - name: Generate app icons
        shell: bash
        run: |
          set -euo pipefail
          SOURCE_ICON="public/FlutterPassword.png"
          
          if [ ! -f "$SOURCE_ICON" ]; then
            echo "âš ï¸  æºå›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $SOURCE_ICONï¼Œè·³è¿‡å›¾æ ‡ç”Ÿæˆ"
            exit 0
          fi
          
          echo "ğŸ¨ ä» $SOURCE_ICON ç”Ÿæˆåº”ç”¨å›¾æ ‡..."
          
          # ç”Ÿæˆ macOS å›¾æ ‡ï¼ˆéœ€è¦ sips å‘½ä»¤ï¼ŒmacOS è‡ªå¸¦ï¼‰
          if [ "${{ runner.os }}" == "macOS" ]; then
            echo "ğŸ“± ç”Ÿæˆ macOS å›¾æ ‡..."
            mkdir -p macos/Runner/Assets.xcassets/AppIcon.appiconset
            sips -z 16 16 "$SOURCE_ICON" --out macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_16.png
            sips -z 32 32 "$SOURCE_ICON" --out macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_32.png
            sips -z 64 64 "$SOURCE_ICON" --out macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_64.png
            sips -z 128 128 "$SOURCE_ICON" --out macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_128.png
            sips -z 256 256 "$SOURCE_ICON" --out macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_256.png
            sips -z 512 512 "$SOURCE_ICON" --out macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_512.png
            cp "$SOURCE_ICON" macos/Runner/Assets.xcassets/AppIcon.appiconset/app_icon_1024.png
            echo "âœ… macOS å›¾æ ‡ç”Ÿæˆå®Œæˆ"
          fi
          
          # ç”Ÿæˆ Windows å›¾æ ‡ï¼ˆéœ€è¦ Python + PIL/Pillowï¼‰
          if [ "${{ runner.os }}" == "Windows" ]; then
            echo "ğŸªŸ ç”Ÿæˆ Windows å›¾æ ‡..."
            # æ£€æŸ¥ Python å’Œ Pillow æ˜¯å¦å¯ç”¨
            if python -c "from PIL import Image" 2>/dev/null; then
              python -c "from PIL import Image; import os; img = Image.open('$SOURCE_ICON'); sizes = [(16, 16), (32, 32), (48, 48), (64, 64), (128, 128), (256, 256)]; icons = [img.resize(size, Image.Resampling.LANCZOS) for size in sizes]; os.makedirs('windows/runner/resources', exist_ok=True); img.save('windows/runner/resources/app_icon.ico', format='ICO', sizes=[(s[0], s[1]) for s in sizes]); print('âœ… Windows å›¾æ ‡ç”Ÿæˆå®Œæˆ')"
            else
              echo "âš ï¸  Python æˆ– Pillow ä¸å¯ç”¨ï¼Œè·³è¿‡ Windows å›¾æ ‡ç”Ÿæˆï¼ˆå°†ä½¿ç”¨ä»“åº“ä¸­çš„ç°æœ‰å›¾æ ‡ï¼‰"
            fi
          fi

      - name: Build macOS (Release)
        if: runner.os == 'macOS'
        run: flutter build macos --release

      - name: Build Windows (Release)
        if: runner.os == 'Windows'
        run: flutter build windows --release

      # ===== macOSï¼šç”Ÿæˆ DMGï¼ˆå¯é€‰ï¼šç­¾å/å…¬è¯ï¼‰=====
      # å¦‚æœä½ é…ç½®äº†ç­¾å/å…¬è¯æ‰€éœ€ secretsï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œç­¾åä¸ notarizeï¼›å¦åˆ™ä»…ç”Ÿæˆæœªç­¾å DMGï¼ˆç”¨äºå†…æµ‹ï¼‰ã€‚
      - name: macOS Sign app (optional)
        if: runner.os == 'macOS' && env.MACOS_CERT_P12_BASE64 != '' && env.MACOS_CERT_PASSWORD != '' && env.MACOS_SIGNING_IDENTITY != ''
        env:
          MACOS_CERT_P12_BASE64: ${{ secrets.MACOS_CERT_P12_BASE64 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        shell: bash
        run: |
          set -euxo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          CERT_PATH="$RUNNER_TEMP/cert.p12"
          echo "$MACOS_CERT_P12_BASE64" | base64 --decode > "$CERT_PATH"
          security create-keychain -p "temp" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "temp" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "$MACOS_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "temp" "$KEYCHAIN_PATH"

          APP_DIR="build/macos/Build/Products/Release"
          APP_PATH="$(find "$APP_DIR" -maxdepth 1 -name '*.app' -print -quit)"
          if [ -z "$APP_PATH" ]; then
            echo "æœªæ‰¾åˆ° .app äº§ç‰©ï¼Œç›®å½•å¦‚ä¸‹ï¼š"
            ls -lah "$APP_DIR" || true
            exit 1
          fi
          codesign --force --deep --options runtime --timestamp --sign "$MACOS_SIGNING_IDENTITY" "$APP_PATH"

      - name: Create macOS DMG
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euxo pipefail
          APP_DIR="build/macos/Build/Products/Release"
          APP_PATH="$(find "$APP_DIR" -maxdepth 1 -name '*.app' -print -quit)"
          if [ -z "$APP_PATH" ]; then
            echo "æœªæ‰¾åˆ° .app äº§ç‰©ï¼Œç›®å½•å¦‚ä¸‹ï¼š"
            ls -lah "$APP_DIR" || true
            exit 1
          fi
          DMG_NAME="FlutterPassword-${APP_VERSION}-macos.dmg"
          hdiutil create -volname "FlutterPassword" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_NAME"
          ls -lah "$DMG_NAME"

      - name: macOS Notarize DMG (optional)
        if: runner.os == 'macOS' && env.APPLE_ID != '' && env.APPLE_TEAM_ID != '' && env.APPLE_APP_SPECIFIC_PASSWORD != ''
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        shell: bash
        run: |
          set -euxo pipefail
          DMG_NAME="FlutterPassword-${APP_VERSION}-macos.dmg"
          xcrun notarytool submit "$DMG_NAME" --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID" --password "$APPLE_APP_SPECIFIC_PASSWORD" --wait
          xcrun stapler staple "$DMG_NAME" || true

      # ===== Windowsï¼šç”Ÿæˆ Inno Setup å®‰è£…åŒ… EXE =====
      - name: Install Inno Setup
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install innosetup --yes --no-progress

      - name: Build Windows installer (Inno Setup)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $src = "build\\windows\\x64\\runner\\Release"
          if (!(Test-Path $src)) { throw "Release folder not found: $src" }
          # Inno Setup å¯¹ç›¸å¯¹è·¯å¾„çš„è§£æåŸºäº .iss æ‰€åœ¨ç›®å½•ï¼Œå®¹æ˜“å¯¼è‡´æ‰¾ä¸åˆ°æ–‡ä»¶ï¼›
          # è¿™é‡Œå¼ºåˆ¶è½¬æˆç»å¯¹è·¯å¾„ä¼ ç»™ ISCCã€‚
          $srcAbs = (Resolve-Path $src).Path
          $exe = Get-ChildItem -Path $srcAbs -Filter *.exe | Select-Object -First 1
          if ($null -eq $exe) { throw "No exe found in $src" }
          $outDir = "$pwd\\dist"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null
          $outDirAbs = (Resolve-Path $outDir).Path
          $iscc = "${env:ProgramFiles(x86)}\\Inno Setup 6\\ISCC.exe"
          if (!(Test-Path $iscc)) { throw "ISCC not found: $iscc" }
          & $iscc `
            "/DAppVersion=$env:APP_VERSION" `
            "/DAppExeName=$($exe.Name)" `
            "/DSourceDir=$srcAbs" `
            "/DOutputDir=$outDirAbs" `
            "packaging\\windows\\FlutterPassword.iss"
          Get-ChildItem -Path $outDir | Format-List

      - name: Upload artifact (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: FlutterPassword-macOS
          path: |
            FlutterPassword-${{ env.APP_VERSION }}-macos.dmg
          if-no-files-found: error

      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: FlutterPassword-Windows
          path: |
            dist/*.exe
          if-no-files-found: error

